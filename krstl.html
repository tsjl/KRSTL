<!DOCTYPE>
<html lang="fi">
	<head>
		<meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
		<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
		<title>KRSTL depends on Javascript</title>
		<script>
var oldHash = ""
// variable for storing the answers of chosen practice form
var vastaukset
// datastructure that contains groups of practices, titles of the groups, names of the practices, titles of the practices, id's of the practices, questions and answers.
var otsikot = [
	{
		// name of the first group
		otsikko: "Collection of practices for small children",
		// the practices in the first group
		"lomakkeet": [
			{
				// the name of the practice shown in the index
				lomake: "Practice 1",
				// the name of the practice shown as a header
				otsikko: "For small children<br>Serie of questions A",
				/* An id of the practice. MAKE SURE THAT VARIABLE llid BELLOW IS UNIQUE. It is used in links and address. */
				llid: "sc_a",
				// collection of the questions and answers
				"kysymykset": [
					{
						// the first question
						kysymys: "What is the name of the dog called Jesse?",
						// the asnwer of the first question stored as a RE matchstring
						vastaus: /^\s*Jesse\s*$/i
					},
					{
						kysymys: "Who wrote the books written by William Shakespeare?",
						vastaus: /^\s*(William\s+Shakespeare|Shakespeare\,?\s+William)\s*$/i
					},
					{
						kysymys: "How many books are there in a trilogy?",
						vastaus: /^\s*(Three|3)\s*$/i
					},
				]
			},
			{
				lomake: "Practice 2",
				otsikko: "For small children<br>Serie of questions b",
				llid: "sc_b",
				"kysymykset": [
					{
						kysymys: "Is this a question?",
						vastaus: /^\s*(yes|y|sure)(\s+it is)?\s*$/i
					},
					{
						kysymys: "Who invented Donald Duck?",
						vastaus: /^\s*(Walt\s+Disney|Disney\,?\s+Walt)\s*$/i
					},
				]
			},
		]
	},
	{
		"otsikko": "Collection of practices for older children",
		"lomakkeet": [
			{
				"lomake": "Questions for older children A",
				otsikko: "Questions for older children<br>Series A",
				llid: "oc_a",
				"kysymykset": [
					{
						kysymys: "What is the first name of Donald Duck?",
						"vastaus": /^\s*Donald\s*$/i
					},
					{
						kysymys: "Does Donald Duck have a family name?",
						"vastaus": /^\s*(yes|duck|y)\s*$/i
					},
				]
			},
		]
	},
]
</script>
<style type="text/css">
body {
	font-family: Arial, Helvetica, sans-serif;
	color:#262626;
}

div#koepaikka {
	margin: 0;
	padding: 0;
}

img.alkukuva, img.loppukuva {
	display: block;
	margin-left: auto;
	margin-right: auto;
}

img.alkukuva {
	padding-top: 5px;
	margin-top: 5px;
	padding-bottom: 5px;
	margin-bottom: 5px;
}
img.loppukuva {
	padding-top: 10px;
	margin-top: 10px;
	padding-bottom: 5px;
	margin-bottom: 5px;
}

h1, h1+h2, p.alaotsake {
	text-align:center;
}

div#ohje { display:none;}

div.ohje {
	margin-bottom:20;
	padding-bottom:20px;
}
div, div.ohje, div.boksi, div.oikea, div.vaara, h1, h1+h2 {
	border-radius:7px;
	margin-top:5px;
	padding-bottom:5px;
	padding-top:5px;
	padding-right:5px;
	padding-left:5px;
	width:auto;
}

div.ohje h2 {
	display: block;
	margin-top:5px;
	margin-bottom: 0px;
	padding-top:5px;
	padding-bottom: 0px;
	margin-left:5px;

}

h1, div.footer {
	margin-top:20px;
	background: #FE642E;
	border: 2px solid #DE2E87;
}

h1 { color: white;}

div.footer {
	color: black;
	display: block;
	text-align: center;
	font-size:80%;
}

div.boksi {
	background: yellow;
	border: 2px solid #FDD267;
}

div.oikea, div.ohje , h1+h2{
	background: #BEF781;
	border: 2px solid #A2C75F;
}

div.vaara {
	background:red;
	border: 2px solid #E95F40;
}

input[type='text'] {
	padding: 5px;
	font-size: 12px;
	outline: none;
	background: -webkit-gradient(linear, left top, left bottom, from(#dddddd), to(#ffffff));
	background: -moz-linear-gradient(top,  #dddddd,  #ffffff);
	-webkit-border-radius: 3px;
	-moz-border-radius: 3px;
	border-radius: 3px;
	border: 1px solid #717171;
	-webkit-box-shadow: 1px 1px 0px #efefef;
	-moz-box-shadow: 1px 1px 0px #efefef;
	box-shadow:  1px 1px 0px #efefef;
}
</style>
<script>

var DEBUG = false;
var DEBUGStr;
if (DEBUGStr == undefined) { 
	if (DEBUG) DEBUGStr = "Debug will be collected to this var\n";
	else DEBUGStr ="Debug is turned of";
}

function DBS(str) {
	/* DBS is a helper function that is used to collect debug information. It takes text or something that can be automatically converted to text by javascript as a parameter. Returns the same text unmodified to make it possible to call this function like alert(DBS("foo"));
	
	Does not store the text if Debug is turned of.
	*/
	if (DEBUG) {
		DEBUGStr += "" + str + "\n";
		/* Fix for IE. IE fails if Debug is on and development console has not been switched on */
		if (typeof console != "undefined") {
			console.log(str);
		}
	}
	return str;
}

function naytaDebug(obj) {
	/* Apufunktio, jolta käytetään kerätyn debug-tiedon näyttämiseen */
	/* BETTERME vois poistaa tai korvata paremmalla, tuotannossa tarpeeton */
	try {
		var elem;
		elem = document.getElementById("debugTahan");
		if (elem != null) {
			elem.innerHTML=DEBUGStr;
		} else {
			var str;
			str = "Debugin paikka kadoksissa, tätä ei pitäisi tapahtua, mutta jostain syystä kuitenkin tapahtui. Pahoittelut, mutta tässä debug kuitenkin näytille:\n" + DEBUGStr
			alert(str);
		}
	} catch (err) {
		alert("errori: " + err);
	}
	return false;
}

function verifioi_ja_anna_palaute(some_obj_in_form) {
	/* Tämä funktio hoitaa käyttäjän antamaan syötteen tarkastamisen ja
	palautteen antamisen käyttäjälle. Voidaan kutsua mistä kohtaa formia vain.
	Tunnistaa formin saamansa argumentin perusteella, joten this on kutsuessa luonteva.

	Palauttaa aina submitin ja siten reloadin estävän falsen */

	/*
	1. tarkistetaan, ollaanko form-elementissä, jos ei, etsitään se
	2. BETTERME huomioi, form-elementistön juuri voi olla joko sisarus tai matkalla
	kohti juurta joko suoraan tai sisaruksena. Em. ongelma ei esiinny nykyisellä
	html:llä, mutta ratkaisu ei toimi yleisesti. Huomioi myös, että vain yksi inputti
	per formi toimii. Käynnistys buttonilla */
	var formElementti;
	DBS("Aloitetaan formin etsintä");
	try {
		formElementti = haeYmparoiva("FORM", some_obj_in_form);
		DBS("Haettu formi löytyi");
	} catch (err) {
		alert(DBS("Formin etsintä meni pieleen:\"" + err + "\""));
	}

	DBS("Aloitetaan kysymyksen numeron etsintä, jotta löydetään oikea vastaus");
	var numero;
	try {
		numero = haeKysymyksenNumero(formElementti);
	} catch (err) {
		alert(DBS("Kysymyksen numeron haussa jotain pieleen: " + err));
		return false;
	}
	DBS("Formin numeron etsintä suoritettu. Numero on " + numero);

	/* Toivu ja ilmoita, jos vastaus puuttuu */
	if (!onkoOikeaVastausSaatavilla(numero)) return false;
	
	DBS("Haetaan ehdotettu vastaus");
	var inputStr;
	try { inputStr = kayttajanInputti(formElementti); }
	catch (err) {
		alert(DBS("Ehdotetun vastauksen haku epäonnistui: " + err));
		return false;
	}

	DBS("Haetaan se div, jolla palaute viestitään");
	try {
		divvi = haeYmparoiva("DIV",formElementti);
		DBS("Löytyi");
	} catch (err) {
		alert(DBS("Ei löydy: " + err));
		return false;
	}

	/* annetun vastauksen tarkistus ja palautteen anto */
	if (inputStr.length == 0) {
		DBS("Tyhjä vastaus");
		divvi.className = "boksi";
	} else if (vastaukset[numero].test(inputStr)) {
		divvi.className = "oikea";
		DBS("Oikein");
		try {
			if (divvi.getElementsByTagName("button").length != 1) throw "Nappien määrä";
			divvi.getElementsByTagName("button")[0].disabled = true;
			if (divvi.getElementsByTagName("input").length != 1) throw "inputtien määrä";
			divvi.getElementsByTagName("input")[0].disabled = true;
		} catch (err) {
			alert(DBS("Disabloinnissa ongelma: " + err));
		}
	} else {
		DBS("Väärä");
		divvi.className = "vaara";
	}
	DBS("palautetaan submitin ja reloadin estävä false");
	return false;
}



function kayttajanInputti(formElementti) {
	/* Apufunktio, joka hakee ja palauttaa käyttäjän syötteen formin ainoasta inputista.
	Ongelmista heitetään poikkeusta ja ilmoitetaan alertein ja lokiin */
	var inputStr;
	if (formElementti.getElementsByTagName("input").length != 1) {
		alert(DBS("Väärä määrä inputteja"));
		throw "Väärä määrä inputteja";
	}
	input = formElementti.getElementsByTagName("input")[0];
	if (input.getAttribute("type")!="text") {
		alert(DBS("Inputin tyyppi väärä"));
		throw "Inputin tyyppi väärä";
	}

	try {
		DBS("Haetaan syöte");
		inputStr = formElementti.getElementsByTagName("input")[0].value;
		if (typeof inputStr != "string") throw "Ei stringiä syötteenä";
	} catch (err) {
		alert(DBS("Vika syötteen haussa: " + err));
		throw "Vika syötteen haussa";
	}	
	return inputStr;
}


function onkoOikeaVastausSaatavilla(numero) {
	/* Apufunktio, jonka avulla varmistetaan oikean vastauksen olemassaolo */
	if (vastaukset == undefined) {
		alert(DBS("vastaukset kadoksissa"));
		return false;
	}
	if (vastaukset && vastaukset[numero] == undefined) {
		alert(DBS("Vastaus numerolla " + numero + " puuttuu!!!"));
		return false;
	}
	return true;
}


function haeYmparoiva(haettava, mistaHaetaan) {
/* Apufunktio, joka ottaa parametreina tyypin, mitä haetaan ja DOM-noden, mistä
ylöspäin puuta aletaan hakea. Huomioi, että haku suntautuu vain puussa suoraan ylöspäin.
Ilmoittaa virhetilanteista heittämällä poikkeuksen
*/
	DBS("haeYmparoiva: parametrien tarkastus");
	
	// parametrien tarkastukset
	if (haettava == undefined
			|| haettava == null
			|| haettava == ""
			|| typeof haettava != 'string'
			|| mistaHaetaan == undefined
			|| mistaHaetaan == null
			|| typeof mistaHaetaan != 'object'
			|| typeof mistaHaetaan.nodeName == "undefined") {
		throw "vikaa parametreissa";
	}
	
	DBS("Parametrit kunnossa. Haku alkaa. Haettava: " + haettava +", mistaHaetaan: " + mistaHaetaan +".");
	
	var i=1;
	while (mistaHaetaan.nodeName != haettava) {
		if (mistaHaetaan.nodeName == "HTML") throw "porattiin html-tagiin asti, ei löytynyt";
		if (mistaHaetaan.parentNode == undefined) throw "parentNode puuttuu.";
		mistaHaetaan = mistaHaetaan.parentNode;
		DBS("Hakukierros " + i + " suoritettu. Ei löytynyt. mistaHaetaan: " + mistaHaetaan);
		i++;
	}
	DBS("Löytyi");	
	return mistaHaetaan;
}

function haeKysymyksenNumero(formObj) {
	/* Etsii kysymyksen numeron oikeaa vastausta varten. Epäonnistumisesta lentää virhe */
	
	DBS("haeKysymyksenNumero() alkaa");
	var i;
	var formElement;
	for (i=0; formElement = document.getElementsByTagName("form")[i]; i++) {
		DBS("Verrataan " + i);
		if (formObj == formElement) {
			DBS("Löytyi: " + i + ".");
			return i;
		}
	}
	DBS("Etsittyä ei löytynyt!!!");
	throw "Etsittyä ei löytynyt!!!";
}

/* Yläpuolinen vastaavaan merkkiin asti leikattu ja liimattu
siistimättä ja sellaisenaan aiemmasta versiosta */

/* stubit erilaisille html-koodin pätkille */
var indexStubs = {
	title: "Practices",
	otsikko: "Practices",
}
var formStub = '<form onSubmit="return verifioi_ja_anna_palaute(this);">\
<input type="text" onBlur="verifioi_ja_anna_palaute(this);" />\
<button type="submit">Check</button></form>'
/* stubit päättyy */

function queryVars() {
/* palauttaa:
0, jos on tarkoitus näyttää lista lomakkeista
viitteen lomakkeeseen, jos on tarkoitus näyttää lomake
korjaa osoitekentän ja latauttaa listan, jos hashiä ei tunnisteta */
	
	// napataan urlista hash-str ilman #-merkkiä
	var queryHash = window.location.hash.substring(1)
	var lomake
	if (queryHash.length == 0) { return 0 }
	else {
		lomake = loytyykoLomake(queryHash)
		if ( lomake != false) {
			// viitattu lomake löytyy
			return lomake
		}
		// hashissa jotain häröä, toivutaan
		window.location.hash=""
		return 0
	}
}

function kont() {
	oldHash = window.location.hash
	var action = queryVars()
	if (action==0) {
		naytaIndeksi()
	} else {
		// vastuu epäkelvoista lomaketunnisteista on queryVars()illa
		naytaLomake(action)
	}
}

function naytaLomake(lomakeRef) {
	if ( lomakeRef.otsikko ) {
		document.title = lomakeRef.otsikko.replace("<br>",", ")
		document.getElementById("otsikko").innerHTML = lomakeRef.otsikko
	} else {
		var viesti =  "Lomakkeen sisällön otsikko puuttuu tai on tyhjä, lomakkeen tunniste: " + lomakeRef.llid
		document.title = viesti
		document.getElementById("otsikko").innerHTML = viesti
	}
	// näytä lomakkeen täytön ohje
	document.getElementById("ohje").style.display="block"
	var koepaikka = document.getElementById("koepaikka")
	// tyhjennä lomakelista tai ed näytetty lomake
	koepaikka.innerHTML=""
	// luodaan kysymykset näytölle
	// alustetaan paikka vastauksille
	vastaukset = new Array()
	for (kv in lomakeRef.kysymykset) {
		naytaKysymys(lomakeRef.kysymykset[kv], koepaikka)
	}
}
			
function naytaKysymys(kysymysRef, minneDOM) {
	var kysymysDiv = document.createElement('div')
	kysymysDiv.className = "boksi"
	var innerHTML = "<p>" + kysymysRef.kysymys + "</p>" + formStub
	vastaukset.push(kysymysRef.vastaus)
	kysymysDiv.innerHTML = innerHTML
	minneDOM.appendChild(kysymysDiv)
}
			
function hashChange() {
	// BETTERME ehto taitaa olla tarpeeton
	if ( oldHash != window.location.hash ) { kont()	}
}
			
function naytaIndeksi() {
	// Tyhjennä lomakelistan paikka
	document.getElementById('koepaikka').innerHTML=""
	// aseta otsikot
	document.title = indexStubs.title
	document.getElementById("otsikko").innerHTML = indexStubs.otsikko
	// piilota ohje
	document.getElementById("ohje").style.display="none"
	// loopataan otsikot
	for (var i = 0; i < otsikot.length; i++) {
		// yhden otsikon käsittelevä looppi
		var obj = otsikot[i]
		var otsikkoInnerHTML = ""
		var otsikkoInnerHTMLend = ""
		for(var key in obj){
			switch (key) {
				case "otsikko":
					otsikkoInnerHTML = "<h2>" + obj[key] + "</h2><p><ul>"
					otsikkoInnerHTMLend = "</ul></p>"
					break
				case "lomakkeet":
					// listataan otsikon alle kuuluvat lomakkeet
					var lomakkeet = obj[key]
					for (var li in lomakkeet) {
						var lomake = lomakkeet[li]
						for(lk in lomake) {
							if (lk == "lomake") {
								otsikkoInnerHTML += "<li><a href='#" + lomake.llid + "'>" + lomake.lomake + "</a>"
							}
						}
					}
					break
				default:
					alert("Väärin nimettyä sisältöä, key: " + key)
					otsikkoInnerHTML += "<li>Virheellistä sisältöä: " + key
			}
		}
		// luodaan divi otsikolle, asetetaan sille sisältö ja laitetaan tulos näkyville
		var otsikkoDiv = document.createElement('div')
		otsikkoDiv.className = "ohje"
		otsikkoDiv.innerHTML = otsikkoInnerHTML + otsikkoInnerHTMLend
		document.getElementById('koepaikka').appendChild(otsikkoDiv)	
	}
}

function loytyykoLomake(id) {
	/* tutkii, löytyykö viitattu lomake
	Palauttaa:
	false, jos ei löydy
	lomakeviitteen, jos löytyy */
	for (var otsikko in otsikot) {
		var lomakkeet = otsikot[otsikko].lomakkeet
		for (var lomake in lomakkeet) {
			if ( id == lomakkeet[lomake].llid ) {
				return lomakkeet[lomake]
			}
		}
	}
	return false
}
		</script>
	</head>
	<body onLoad="kont()" onhashchange="hashChange()">
		<img class="alkukuva" src="your_logo.jpg" />
		<noscript>This software can not be run without Javascript.</noscript>
		<h1 id="otsikko"></h1>
		<div id="ohje" class="ohje">
			<p>
				Find answers e. g. from
				<a target="_blank" href="http://en.wikipedia.org/">Wikipedia</a> or
				<a target="_blank" href="https://duckduckgo.com">DuckDuckGo</a>.
				Correct answer will be awarded with green. Wrong with red. When you get all of the boxes green, you've passed the exercise!
			</p>
		</div>
		<div id="koepaikka">
		</div>
		<img class="loppukuva" src="your_logo.jpg" />
		<div class="footer">
			<p>
				<!-- Change your contact information bellow. -->
				This collection of practices is made with <a href="http://s.iki.fi/krstl">KRSTL</a>.
				KRSTL is given to be used and to be modified with no warranty what so ever.
				This practice form software was developed in Oulu City library in spring 2013. The forms give feedback to the user. Answers are not stored anywhere. Implementation was made by Sampo Lehtinen.
			</p>
			<p>
				Contacts:<br />
			</p>
		</div>
	</body>
</html>
	
